<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4484059199027769"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Data Mind - Post</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>The Data Mind</h2>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Home</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <a href="profile.html" class="nav-link" id="profile-link" style="display: none;">Profile</a>
                <a href="login.html" class="nav-link" id="login-link">Login</a>
                <a href="signup.html" class="nav-link" id="signup-link">Sign Up</a>
            </div>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Post Content -->
            <div id="post-content" class="post-detail-page">
                <!-- Post will be loaded here -->
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading post...</p>
            </div>

            <!-- Error -->
            <div class="no-posts" id="error" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Post not found</h3>
                <p>The post you're looking for doesn't exist or has been removed.</p>
                <a href="index.html" class="form-btn">Go Home</a>
            </div>

            <!-- Related Posts -->
            <div class="related-posts" id="related-posts" style="display: none;">
                <h3>More Posts</h3>
                <div class="posts-container" id="related-posts-container">
                    <!-- Related posts will be loaded here -->
                </div>
            </div>
        </div>
    </main>

      <footer class="footer">
        <div class="footer-links">
            <a href="index.html">Home</a>
            <a href="about.html">About</a>
            <a href="contact.html">Contact</a>
            <a href="privacy policy.html">Privacy Policy</a>
        </div>
        <div class="footer-social">
            <a href="https://github.com/" target="_blank" aria-label="GitHub"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.157-1.11-1.465-1.11-1.465-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.203 2.397.1 2.65.64.7 1.028 1.595 1.028 2.688 0 3.847-2.338 4.695-4.566 4.944.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.749 0 .267.18.579.688.481C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"/></svg></a>
            <a href="https://twitter.com/" target="_blank" aria-label="Twitter"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557a9.83 9.83 0 0 1-2.828.775 4.932 4.932 0 0 0 2.165-2.724c-.951.564-2.005.974-3.127 1.195a4.916 4.916 0 0 0-8.38 4.482C7.691 8.095 4.066 6.13 1.64 3.161c-.542.929-.856 2.01-.857 3.17 0 2.188 1.115 4.117 2.823 5.254a4.904 4.904 0 0 1-2.229-.616c-.054 2.281 1.581 4.415 3.949 4.89a4.936 4.936 0 0 1-2.224.084c.627 1.956 2.444 3.377 4.6 3.417A9.867 9.867 0 0 1 0 21.543a13.94 13.94 0 0 0 7.548 2.209c9.057 0 14.009-7.496 14.009-13.986 0-.21-.005-.423-.015-.633A9.936 9.936 0 0 0 24 4.557z"/></svg></a>
            <a href="https://linkedin.com/" target="_blank" aria-label="LinkedIn"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-10h3v10zm-1.5-11.268c-.966 0-1.75-.784-1.75-1.75s.784-1.75 1.75-1.75 1.75.784 1.75 1.75-.784 1.75-1.75 1.75zm15.5 11.268h-3v-5.604c0-1.337-.025-3.063-1.868-3.063-1.868 0-2.154 1.459-2.154 2.968v5.699h-3v-10h2.881v1.367h.041c.401-.761 1.379-1.563 2.841-1.563 3.039 0 3.6 2.001 3.6 4.601v5.595z"/></svg></a>
        </div>
        <div class="footer-copy">&copy; 2024 The Data Mind. All rights reserved.</div>
    </footer>
    <script src="firebase-config.js"></script>
    <script src="cache.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let currentPost = null;
        let comments = [];

        // DOM elements
        const postContent = document.getElementById('post-content');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const relatedPosts = document.getElementById('related-posts');
        const relatedPostsContainer = document.getElementById('related-posts-container');
        const profileLink = document.getElementById('profile-link');
        const loginLink = document.getElementById('login-link');
        const signupLink = document.getElementById('signup-link');

        // Initialize post page
        document.addEventListener('DOMContentLoaded', function() {
            initializePostPage();
            setupEventListeners();
        });

        // Initialize post page
        function initializePostPage() {
            // Get post ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            
            if (!postId) {
                showError();
                return;
            }

            // Check authentication state
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                updateNavigation();
                await loadPost(postId);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Mobile menu toggle
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');
            
            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
        }

        // Update navigation based on authentication
        function updateNavigation() {
            if (currentUser) {
                profileLink.style.display = 'inline';
                loginLink.style.display = 'none';
                signupLink.style.display = 'none';
            } else {
                profileLink.style.display = 'none';
                loginLink.style.display = 'inline';
                signupLink.style.display = 'inline';
            }
        }

        // Load post
        async function loadPost(postId) {
            try {
                loading.style.display = 'block';
                error.style.display = 'none';
                postContent.innerHTML = '';
                const cacheKey = `post_${postId}`;
                const cached = cache.get(cacheKey);
                if (cached && cached.id === postId) {
                    currentPost = cached;
                } else {
                    const postDoc = await db.collection('posts').doc(postId).get({ source: 'server' });
                    if (!postDoc.exists) {
                        showError();
                        return;
                    }
                    currentPost = { id: postDoc.id, ...postDoc.data() };
                    // Cache post details for 60 minutes
                    cache.set(cacheKey, currentPost, 1000 * 60 * 60);
                }
                
                // Increment view count
                await incrementViewCount(postId);
                currentPost.views = (currentPost.views || 0) + 1;
                
                renderPost();
                await loadComments();
                await loadRelatedPosts();
                
            } catch (error) {
                console.error('Error loading post:', error);
                showError();
            } finally {
                loading.style.display = 'none';
            }
        }

        // Render post
        function renderPost() {
            if (!currentPost) return;

            const authorInitials = getAuthorInitials(currentPost.authorName);
            const formattedDate = formatDate(currentPost.createdAt);

            // Detect if content is point-wise
            let renderedContent = '';
            const lines = (currentPost.content || '').split('\n');
            const isPointList = lines.every(line => /^\s*([-*]|\d+\.)\s+/.test(line) || line.trim() === '');
            if (isPointList) {
                renderedContent = '<ul>' + lines.filter(line => line.trim() !== '').map(line => {
                    return '<li>' + line.replace(/^\s*([-*]|\d+\.)\s+/, '') + '</li>';
                }).join('') + '</ul>';
            } else {
                renderedContent = '<div class="post-content">' + currentPost.content.replace(/\n/g, '<br>') + '</div>';
            }

            postContent.innerHTML = `
                <div class="post-detail">
                    <div class="post-header">
                        <div class="author-avatar">${authorInitials}</div>
                        <div class="author-info">
                            <h4 class="author-name" onclick="openUserProfile('${currentPost.authorName}')">${currentPost.authorName}</h4>
                            <span class="post-date">${formattedDate}</span>
                        </div>
                    </div>
                    <h1 class="post-title">${currentPost.title}</h1>
                    ${renderedContent}
                    <div class="post-stats">
                        <div class="stats-left">
                            <div class="stat-item">
                                <i class="fas fa-eye"></i>
                                <span>${currentPost.views || 0}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-heart"></i>
                                <span>${currentPost.likes || 0}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-comment"></i>
                                <span>${currentPost.commentCount || 0}</span>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button class="action-btn like-btn ${currentPost.likedBy && currentPost.likedBy.includes(currentUser?.uid) ? 'liked' : ''}" 
                                    onclick="toggleLike()">
                                <i class="fas fa-heart"></i>
                                Like
                            </button>
                            <button class="action-btn share-btn" onclick="sharePost()">
                                <i class="fas fa-share"></i>
                                Share
                            </button>
                        </div>
                    </div>
                    <div class="comments-section">
                        <div class="comments-header">
                            <h3>Comments (${currentPost.commentCount || 0})</h3>
                            <button class="comment-toggle-btn" onclick="toggleComments()">
                                <i class="fas fa-comments"></i>
                                Show Comments
                            </button>
                        </div>
                        <div class="comments-container" id="comments-container" style="display: none;">
                            ${currentUser ? `
                                <div class="comment-form">
                                    <textarea class="comment-input" id="comment-input" placeholder="Write a comment..."></textarea>
                                    <button class="comment-submit" onclick="addComment()">Post Comment</button>
                                </div>
                            ` : '<p>Please <a href="login.html">login</a> to comment.</p>'}
                            <div class="comments-list" id="comments-list">
                                <!-- Comments will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load comments
        async function loadComments() {
            try {
                const commentsList = document.getElementById('comments-list');
                if (!commentsList) return;

                const snapshot = await db.collection('posts').doc(currentPost.id).collection('comments').orderBy('createdAt', 'desc').get({ source: 'server' });
                
                comments = [];
                commentsList.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const comment = { id: doc.id, ...doc.data() };
                    comments.push(comment);
                    const commentElement = createCommentElement(comment);
                    commentsList.appendChild(commentElement);
                });
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        // Create comment element
        function createCommentElement(comment) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            
            const formattedDate = formatDate(comment.createdAt);
            const isAuthor = currentUser && comment.authorId === currentUser.uid;
            
            commentDiv.innerHTML = `
                <div class="comment-header">
                    <div class="author-info">
                        <span class="comment-author" onclick="openUserProfile('${comment.authorName}')">${comment.authorName}</span>
                        <span class="comment-date">${formattedDate}</span>
                    </div>
                    ${isAuthor ? `
                        <div class="comment-actions">
                            <button class="comment-action" onclick="editComment('${comment.id}')">Edit</button>
                            <button class="comment-action" onclick="deleteComment('${comment.id}')">Delete</button>
                        </div>
                    ` : ''}
                </div>
                <div class="comment-content" id="comment-content-${comment.id}">${comment.content}</div>
                <div class="comment-actions">
                    <button class="comment-action" onclick="toggleReplyForm('${comment.id}')">Reply</button>
                    ${comment.replyCount > 0 ? `
                        <button class="comment-action" onclick="toggleReplies('${comment.id}')">
                            ${comment.replyCount} replies
                        </button>
                    ` : ''}
                </div>
                <div class="reply-form" id="reply-form-${comment.id}" style="display: none;">
                    <textarea class="reply-input" id="reply-input-${comment.id}" placeholder="Write a reply..."></textarea>
                    <button class="reply-submit" onclick="addReply('${comment.id}')">Reply</button>
                </div>
                <div class="replies" id="replies-${comment.id}" style="display: block;">
                    <!-- Replies will be loaded here -->
                </div>
            `;

            // Always load replies for this comment
            loadReplies(comment.id);

            return commentDiv;
        }

        // Toggle comments visibility
        function toggleComments() {
            const commentsContainer = document.getElementById('comments-container');
            const toggleBtn = document.querySelector('.comment-toggle-btn');
            
            if (commentsContainer.style.display === 'none') {
                commentsContainer.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-comments"></i> Hide Comments';
            } else {
                commentsContainer.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-comments"></i> Show Comments';
            }
        }

        // Add comment
        async function addComment() {
            if (!currentUser) {
                showError('Please login to comment.');
                return;
            }

            const commentInput = document.getElementById('comment-input');
            const content = commentInput.value.trim();
            
            if (!content) {
                showError('Please enter a comment.');
                return;
            }

            try {
                const commentData = {
                    content: content,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email.split('@')[0],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    replyCount: 0
                };

                await db.collection('posts').doc(currentPost.id).collection('comments').add(commentData);
                
                // Update comment count
                await db.collection('posts').doc(currentPost.id).update({
                    commentCount: firebase.firestore.FieldValue.increment(1)
                });

                // Invalidate cache for this post after comment
                cache.clear(`post_${currentPost.id}`);

                commentInput.value = '';
                await loadComments();
                
                // Update post data
                currentPost.commentCount = (currentPost.commentCount || 0) + 1;
                updatePostStats();
                
            } catch (error) {
                console.error('Error adding comment:', error);
                showError('Failed to add comment. Please try again.');
            }
        }

        // Add reply
        async function addReply(commentId) {
            if (!currentUser) {
                showError('Please login to reply.');
                return;
            }

            const replyInput = document.getElementById(`reply-input-${commentId}`);
            const content = replyInput.value.trim();
            
            if (!content) {
                showError('Please enter a reply.');
                return;
            }

            try {
                const replyData = {
                    content: content,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email.split('@')[0],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    parentCommentId: commentId
                };

                await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).collection('replies').add(replyData);
                
                // Update reply count
                await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).update({
                    replyCount: firebase.firestore.FieldValue.increment(1)
                });

                replyInput.value = '';
                toggleReplyForm(commentId);
                await loadReplies(commentId);
                
            } catch (error) {
                console.error('Error adding reply:', error);
                showError('Failed to add reply. Please try again.');
            }
        }

        // Toggle reply form
        function toggleReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
        }

        // Toggle replies
        async function toggleReplies(commentId) {
            const repliesDiv = document.getElementById(`replies-${commentId}`);
            
            if (repliesDiv.style.display === 'none') {
                repliesDiv.style.display = 'block';
                await loadReplies(commentId);
            } else {
                repliesDiv.style.display = 'none';
            }
        }

        // Load replies
        async function loadReplies(commentId) {
            try {
                const repliesDiv = document.getElementById(`replies-${commentId}`);
                const snapshot = await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).collection('replies').orderBy('createdAt', 'asc').get({ source: 'server' });
                
                repliesDiv.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const reply = { id: doc.id, ...doc.data() };
                    const replyElement = createReplyElement(reply, commentId);
                    repliesDiv.appendChild(replyElement);
                });
            } catch (error) {
                console.error('Error loading replies:', error);
            }
        }

        // Create reply element
        function createReplyElement(reply, commentId) {
            const replyDiv = document.createElement('div');
            replyDiv.className = 'comment';
            
            const formattedDate = formatDate(reply.createdAt);
            const isAuthor = currentUser && reply.authorId === currentUser.uid;
            
            replyDiv.innerHTML = `
                <div class="comment-header">
                    <div class="author-info">
                        <span class="comment-author" onclick="openUserProfile('${reply.authorName}')">${reply.authorName}</span>
                        <span class="comment-date">${formattedDate}</span>
                    </div>
                    ${isAuthor ? `
                        <div class="comment-actions">
                            <button class="comment-action" onclick="editReply('${commentId}', '${reply.id}')">Edit</button>
                            <button class="comment-action" onclick="deleteReply('${commentId}', '${reply.id}')">Delete</button>
                        </div>
                    ` : ''}
                </div>
                <div class="comment-content" id="reply-content-${reply.id}">${reply.content}</div>
            `;

            return replyDiv;
        }

        // Edit comment
        function editComment(commentId) {
            const contentDiv = document.getElementById(`comment-content-${commentId}`);
            const currentContent = contentDiv.textContent;
            
            contentDiv.innerHTML = `
                <textarea class="comment-input" id="edit-comment-${commentId}">${currentContent}</textarea>
                <button class="comment-submit" onclick="saveCommentEdit('${commentId}')">Save</button>
                <button class="comment-action" onclick="cancelCommentEdit('${commentId}')">Cancel</button>
            `;
        }

        // Save comment edit
        async function saveCommentEdit(commentId) {
            const editInput = document.getElementById(`edit-comment-${commentId}`);
            const newContent = editInput.value.trim();
            
            if (!newContent) {
                showError('Comment cannot be empty.');
                return;
            }

            try {
                await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).update({
                    content: newContent
                });
                
                await loadComments();
            } catch (error) {
                console.error('Error editing comment:', error);
                showError('Failed to edit comment. Please try again.');
            }
        }

        // Cancel comment edit
        function cancelCommentEdit(commentId) {
            loadComments();
        }

        // Delete comment
        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }

            try {
                await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).delete();
                
                // Update comment count
                await db.collection('posts').doc(currentPost.id).update({
                    commentCount: firebase.firestore.FieldValue.increment(-1)
                });

                await loadComments();
                
                // Update post data
                currentPost.commentCount = Math.max(0, (currentPost.commentCount || 0) - 1);
                updatePostStats();
                
            } catch (error) {
                console.error('Error deleting comment:', error);
                showError('Failed to delete comment. Please try again.');
            }
        }

        // Edit reply
        function editReply(commentId, replyId) {
            const contentDiv = document.getElementById(`reply-content-${replyId}`);
            const currentContent = contentDiv.textContent;
            
            contentDiv.innerHTML = `
                <textarea class="reply-input" id="edit-reply-${replyId}">${currentContent}</textarea>
                <button class="reply-submit" onclick="saveReplyEdit('${commentId}', '${replyId}')">Save</button>
                <button class="comment-action" onclick="cancelReplyEdit('${commentId}', '${replyId}')">Cancel</button>
            `;
        }

        // Save reply edit
        async function saveReplyEdit(commentId, replyId) {
            const editInput = document.getElementById(`edit-reply-${replyId}`);
            const newContent = editInput.value.trim();
            
            if (!newContent) {
                showError('Reply cannot be empty.');
                return;
            }

            try {
                await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).collection('replies').doc(replyId).update({
                    content: newContent
                });
                
                await loadReplies(commentId);
            } catch (error) {
                console.error('Error editing reply:', error);
                showError('Failed to edit reply. Please try again.');
            }
        }

        // Cancel reply edit
        function cancelReplyEdit(commentId, replyId) {
            loadReplies(commentId);
        }

        // Delete reply
        async function deleteReply(commentId, replyId) {
            if (!confirm('Are you sure you want to delete this reply?')) {
                return;
            }

            try {
                await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).collection('replies').doc(replyId).delete();
                
                // Update reply count
                await db.collection('posts').doc(currentPost.id).collection('comments').doc(commentId).update({
                    replyCount: firebase.firestore.FieldValue.increment(-1)
                });

                await loadReplies(commentId);
                
            } catch (error) {
                console.error('Error deleting reply:', error);
                showError('Failed to delete reply. Please try again.');
            }
        }

        // Toggle like
        async function toggleLike() {
            if (!currentUser) {
                showError('Please login to like posts.');
                return;
            }

            try {
                const postRef = db.collection('posts').doc(currentPost.id);
                const likedBy = currentPost.likedBy || [];
                const isLiked = likedBy.includes(currentUser.uid);
                
                if (isLiked) {
                    likedBy.splice(likedBy.indexOf(currentUser.uid), 1);
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.increment(-1),
                        likedBy: likedBy
                    });
                    currentPost.likes = (currentPost.likes || 1) - 1;
                } else {
                    likedBy.push(currentUser.uid);
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.increment(1),
                        likedBy: likedBy
                    });
                    currentPost.likes = (currentPost.likes || 0) + 1;
                }
                
                currentPost.likedBy = likedBy;
                // Invalidate cache for this post after like
                cache.clear(`post_${currentPost.id}`);
                updatePostStats();
                
            } catch (error) {
                console.error('Error toggling like:', error);
                showError('Failed to update like. Please try again.');
            }
        }

        // Share post
        function sharePost() {
            const url = window.location.href;
            const text = `Check out this post: ${currentPost.title}`;

            if (navigator.share) {
                navigator.share({
                    title: currentPost.title,
                    text: text,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    showSuccess('Link copied to clipboard!');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showSuccess('Link copied to clipboard!');
                });
            }
        }

        // Load related posts
        async function loadRelatedPosts() {
            try {
                const snapshot = await db.collection('posts')
                    .where('authorId', '==', currentPost.authorId)
                    .where('__name__', '!=', currentPost.id)
                    .orderBy('__name__')
                    .limit(3)
                    .get({ source: 'server' });

                const relatedPostsArray = [];
                snapshot.forEach(doc => {
                    const post = { id: doc.id, ...doc.data() };
                    relatedPostsArray.push(post);
                });

                if (relatedPostsArray.length > 0) {
                    renderRelatedPosts(relatedPostsArray);
                    relatedPosts.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading related posts:', error);
            }
        }

        // Render related posts
        function renderRelatedPosts(posts) {
            relatedPostsContainer.innerHTML = '';
            
            posts.forEach(post => {
                const postElement = createRelatedPostElement(post);
                relatedPostsContainer.appendChild(postElement);
            });
        }

        // Create related post element
        function createRelatedPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post-card';
            
            const formattedDate = formatDate(post.createdAt);
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <div class="author-info">
                        <h4 class="post-title" onclick="openPost('${post.id}')">${post.title}</h4>
                        <span class="post-date">${formattedDate}</span>
                    </div>
                </div>
                <p class="post-content">${truncateText(post.content, 150)}</p>
                <div class="post-stats">
                    <div class="stats-left">
                        <div class="stat-item">
                            <i class="fas fa-eye"></i>
                            <span>${post.views || 0}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-heart"></i>
                            <span>${post.likes || 0}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-comment"></i>
                            <span>${post.commentCount || 0}</span>
                        </div>
                    </div>
                </div>
            `;

            return postDiv;
        }

        // Update post stats
        function updatePostStats() {
            const statsElements = document.querySelectorAll('.post-detail .stat-item span');
            if (statsElements.length >= 3) {
                statsElements[0].textContent = currentPost.views || 0;
                statsElements[1].textContent = currentPost.likes || 0;
                statsElements[2].textContent = currentPost.commentCount || 0;
            }
        }

        // Increment view count
        async function incrementViewCount(postId) {
            try {
                await db.collection('posts').doc(postId).update({
                    views: firebase.firestore.FieldValue.increment(1)
                });
            } catch (error) {
                console.error('Error incrementing view count:', error);
            }
        }

        // Open user profile
        function openUserProfile(authorName) {
            window.location.href = `user.html?author=${encodeURIComponent(authorName)}`;
        }

        // Open post
        function openPost(postId) {
            window.location.href = `post.html?id=${postId}`;
        }

        // Show error
        function showError() {
            loading.style.display = 'none';
            error.style.display = 'block';
        }

        // Utility functions
        function getAuthorInitials(authorName) {
            if (!authorName) return '?';
            return authorName.split(' ').map(name => name.charAt(0)).join('').toUpperCase().substring(0, 2);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.insertBefore(successDiv, document.body.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html> 
